

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Sorting and Layouting &mdash; odgi 00d68c2 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Translate path positions between graphs" href="translate_path_positions_between_graphs.html" />
    <link rel="prev" title="Extract selected loci" href="extract_selected_loci.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> odgi
          

          
          </a>

          
            
            
              <div class="version">
                v0.5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="exploratory_analysis.html">Exploratory analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="detect_complex_regions.html">Detect complex regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="extract_selected_loci.html">Extract selected <cite>loci</cite></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Sorting and Layouting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#synopsis">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#steps">Steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-the-unsorted-drb1-3123-graph">Build the unsorted DRB1-3123 graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualize-the-unsorted-drb1-3123-graph">Visualize the unsorted DRB1-3123 graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#d-layout-metrics-of-the-unsorted-drb1-3123-graph">1D layout metrics of the unsorted DRB1-3123 graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sort-the-unsorted-drb1-3123-graph-in-1d">Sort the unsorted DRB1-3123 graph in 1D</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualize-the-1d-sorted-drb1-3123-graph">Visualize the 1D sorted DRB1-3123 graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#d-layout-metrics-of-the-sorted-drb1-3123-graph">1D layout metrics of the sorted DRB1-3123 graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#d-layout-of-the-unsorted-drb1-3123-graph">2D layout of the unsorted DRB1-3123 graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#drawing-the-2d-layout-of-the-drb1-3123-graph">Drawing the 2D layout of the DRB1-3123 graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interactive-visualization-with-gfaestus">Interactive visualization with gfaestus</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="translate_path_positions_between_graphs.html">Translate path positions between graphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="remove_artifacts_and_complex_regions.html">Remove artifacts and complex regions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../commands.html">Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../binding.html">Python Binding</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">odgi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>Sorting and Layouting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/rst/tutorials/sorting_layouting.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sorting-and-layouting">
<span id="sorting-layouting"></span><h1>Sorting and Layouting<a class="headerlink" href="#sorting-and-layouting" title="Permalink to this headline">¶</a></h1>
<div class="section" id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h2>
<p>Pangenome graphs built from raw sets of alignments may have complex structures which can introduce difficulty in
downstream analyses, visualization, mapping, and interpretation. Graph sorting aims to find the best node order for
a 1D and 2D layout to simplify these complex regions. Pangenome graphs embed linear pangenomic sequences as paths in
the graph, but to our knowledge, no algorithm takes into account this biological information in the sorting. Moreover,
existing 2D layout methods struggle to deal with large graphs. <code class="docutils literal notranslate"><span class="pre">odgi</span></code> implements a new layout algorithm to simplify a pangenome
graph, by using path-guided <a class="reference external" href="https://ieeexplore.ieee.org/document/8419285">stochastic gradient descent</a>
(<a class="reference external" href="https://docs.google.com/presentation/d/1SfFAtesY6NkSzolo3kN2s3LV5eFunko6KoCv5PkH-YI/edit#slide=id.p">PG-SGD</a>) to move a single pair of nodes at a time.
The PG-SGD is memory polite, because it uses a path index, a strict subset of the <a class="reference external" href="https://github.com/vgteam/xg">xg</a> index. Following a parallelized, lock-free SGD approach,
the PG-SGD can go <a class="reference external" href="https://papers.nips.cc/paper/2011/hash/218a0aefd1d1a4be65601cc6ddc1520e-Abstract.html">Hogwild</a>!</p>
<blockquote>
<div><p>The 1D path-guided SGD implementation is a key step in general pangenome analyses such as pangenome graph
linearization and simplification. It is applied in the <a class="reference external" href="https://github.com/pangenome/pggb">PangenomeGraph Builder</a> (PGGB) pipeline.</p>
</div></blockquote>
<p>This tutorial shows how to sort and visualize a graph in 1D. It explains how to generate a 2D layout of a graph, and how
to take a look at the calculated layout using static and interactive tools.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be aware that <a class="reference internal" href="../commands/odgi_sort.html#odgi-sort"><span class="std std-ref">odgi sort</span></a> offers much more sorting algorithms than this tutorial could cover here.</p>
</div>
</div>
<div class="section" id="steps">
<h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<div class="section" id="build-the-unsorted-drb1-3123-graph">
<h3>Build the unsorted DRB1-3123 graph<a class="headerlink" href="#build-the-unsorted-drb1-3123-graph" title="Permalink to this headline">¶</a></h3>
<p>Assuming that your current working directory is the root of the <code class="docutils literal notranslate"><span class="pre">odgi</span></code> project, to construct an <code class="docutils literal notranslate"><span class="pre">odgi</span></code> graph from the
<code class="docutils literal notranslate"><span class="pre">DRB1-3123</span></code> dataset in <code class="docutils literal notranslate"><span class="pre">GFA</span></code> format, execute:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi build -g test/DRB1-3123_unsorted.gfa -o DRB1-3123_unsorted.og
</pre></div>
</div>
<p>The command creates a file called <code class="docutils literal notranslate"><span class="pre">DRB1-3123_unsorted.og</span></code>, which contains the input graph in <code class="docutils literal notranslate"><span class="pre">odgi</span></code> format. This graph contains
12 ALT sequences of the <a class="reference external" href="https://www.ncbi.nlm.nih.gov/gene/3123">HLA-DRB1 gene</a> from the GRCh38 reference genome.
The graph was initially created with the <a class="reference external" href="https://github.com/ekg/seqwish">seqwish</a> variation graph inducer which produces unsorted, raw graphs from
all versus all alignments of the input sequences.</p>
</div>
<div class="section" id="visualize-the-unsorted-drb1-3123-graph">
<h3>Visualize the unsorted DRB1-3123 graph<a class="headerlink" href="#visualize-the-unsorted-drb1-3123-graph" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi viz -i DRB1-3123_unsorted.og -o DRB1-3123_unsorted.png
</pre></div>
</div>
<p>To obtain the following PNG image:</p>
<img alt="img/DRB1-3123_unsorted.png" src="img/DRB1-3123_unsorted.png" />
<p>In this 1-Dimensional visualization:</p>
<ul class="simple">
<li><p>The graph nodes are arranged from left to right, forming the <code class="docutils literal notranslate"><span class="pre">pangenome</span> <span class="pre">sequence</span></code>.</p></li>
<li><p>The colored bars represent the binned, linearized renderings of the embedded paths versus this <code class="docutils literal notranslate"><span class="pre">pangenome</span> <span class="pre">sequence</span></code> in a binary matrix.</p></li>
<li><p>The path names are visualized on the left.</p></li>
<li><p>The black lines under the paths are the links, which represent the graph topology.</p></li>
</ul>
<p>The graph is very complex and, in this form, the underlying structure is unclear. It is hard to reason from it.
It is a perfect candidate for the 1D PG-SGD: It will find the best 1D node order effectively linearizing it.</p>
</div>
<div class="section" id="d-layout-metrics-of-the-unsorted-drb1-3123-graph">
<h3>1D layout metrics of the unsorted DRB1-3123 graph<a class="headerlink" href="#d-layout-metrics-of-the-unsorted-drb1-3123-graph" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../commands/odgi_stats.html#odgi-stats"><span class="std std-ref">odgi stats</span></a> provides metrics to evaluate the goodness of the sort of a variation graph. Let’s take a look:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi stats -i DRB1-3123_unsorted.og -s -d -l -g
</pre></div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-s</span></code> calculates the sum of path node distances.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-l</span></code> calculates the mean links length.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-d</span></code> additionally penalizes links which connect nodes with different orientation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-g</span></code> ensures that gap links, links directly travelling from left to right encoding simple structural variants, are not penalized.</p></li>
</ul>
<p>For further details on these metrics please take a look at the <a class="reference internal" href="../commands/odgi_stats.html#odgi-stats"><span class="std std-ref">odgi stats</span></a> command.</p>
<p>We observe on stdout:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#mean_links_length</span>
path        in_node_space   in_nucleotide_space     num_links_considered    num_gap_links_not_penalized
all_paths   <span class="m">514</span>.698 <span class="m">4016</span>.92 <span class="m">21870</span>   <span class="m">11116</span>
<span class="c1">#sum_of_path_node_distances</span>
path        in_node_space   in_nucleotide_space     nodes   nucleotides     num_penalties   num_penalties_different_orientation
all_paths   <span class="m">1029</span>.84 <span class="m">1076</span>.32 <span class="m">21882</span>   <span class="m">163416</span>  <span class="m">6085</span>    <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="section" id="sort-the-unsorted-drb1-3123-graph-in-1d">
<h3>Sort the unsorted DRB1-3123 graph in 1D<a class="headerlink" href="#sort-the-unsorted-drb1-3123-graph-in-1d" title="Permalink to this headline">¶</a></h3>
<p>Let’s sort the graph with the 1D PG-SGD algorithm:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi sort -i DRB1-3123_unsorted.og --threads <span class="m">2</span> -P -Y -o DRB1-3123_sorted.og
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">-Y</span></code> selects the PG-SGD algorithm for sorting. This algorithm moves a single pair of nodes at a time, optimizing
the disparity between the layout distance of a node pair and the actual nucleotide distance of a path traversing these
nodes.</p>
<img alt="img/SGD.png" src="img/SGD.png" />
<p>Figure from <a class="reference external" href="https://ieeexplore.ieee.org/document/8419285">Zheng et al., IEEE 2019</a>.</p>
<ul class="simple">
<li><p>The first node <em>X</em><sub>i</sub> of a pair is a uniform path step pick from all nodes.</p></li>
<li><p>The second node <em>X</em><sub>j</sub> of a pair is sampled from the same path following a Zipfian distribution.</p></li>
<li><p>The path nucleotide distance of the nodes in the pair guides the actual layout distance <em>d</em><sub>ij</sub> update of these nodes.</p></li>
<li><p>The magnitude <em>r</em> of the update depends on the current learning rate of the SGD.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The PG-SGD is not deterministic, because of its <a class="reference external" href="https://papers.nips.cc/paper/2011/hash/218a0aefd1d1a4be65601cc6ddc1520e-Abstract.html">Hogwild!</a> approach.
To reproduce the visualization below, the sorted graph can be found under <code class="docutils literal notranslate"><span class="pre">test/DRB1-3123_sorted.og</span></code>.</p>
</div>
</div>
<div class="section" id="visualize-the-1d-sorted-drb1-3123-graph">
<h3>Visualize the 1D sorted DRB1-3123 graph<a class="headerlink" href="#visualize-the-1d-sorted-drb1-3123-graph" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi viz -i DRB1-3123_sorted.og -o DRB1-3123_sorted.png
</pre></div>
</div>
<img alt="img/DRB1-3123_sorted.png" src="img/DRB1-3123_sorted.png" />
<p>The graph lost it’s complexity and is now linear.</p>
</div>
<div class="section" id="d-layout-metrics-of-the-sorted-drb1-3123-graph">
<h3>1D layout metrics of the sorted DRB1-3123 graph<a class="headerlink" href="#d-layout-metrics-of-the-sorted-drb1-3123-graph" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi stats -i DRB1-3123_sorted.og -s -d -l -g
</pre></div>
</div>
<p>This prints to stdout:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#mean_links_length</span>
path        in_node_space   in_nucleotide_space     num_links_considered    num_gap_links_not_penalized
all_paths   <span class="m">2</span>.15542 <span class="m">15</span>.0529 <span class="m">21870</span>   <span class="m">9481</span>
<span class="c1">#sum_of_path_node_distances</span>
path        in_node_space   in_nucleotide_space     nodes   nucleotides     num_penalties   num_penalties_different_orientation
all_paths   <span class="m">4</span>.66114 <span class="m">4</span>.72171 <span class="m">21882</span>   <span class="m">163416</span>  <span class="m">5948</span>    <span class="m">1</span>
</pre></div>
</div>
<p>Compare to before, these metrics show that the goodness of the sorting of the graph improved significantly. Great!</p>
</div>
<div class="section" id="d-layout-of-the-unsorted-drb1-3123-graph">
<h3>2D layout of the unsorted DRB1-3123 graph<a class="headerlink" href="#d-layout-of-the-unsorted-drb1-3123-graph" title="Permalink to this headline">¶</a></h3>
<p>We want to have a 2D layout of our DRB1-3123 graph:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi layout -i DRB1-3123_unsorted.og -o DRB1-3123_unsorted.og.lay -P --threads <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="section" id="drawing-the-2d-layout-of-the-drb1-3123-graph">
<h3>Drawing the 2D layout of the DRB1-3123 graph<a class="headerlink" href="#drawing-the-2d-layout-of-the-drb1-3123-graph" title="Permalink to this headline">¶</a></h3>
<p>Calculate the 2D layout:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi draw -i DRB1-3123_unsorted.og -c DRB1-3123_unsorted.og.lay -p DRB1-3123_unsorted.og.lay.png -C -w <span class="m">50</span>
</pre></div>
</div>
<img alt="img/DRB1-3123_unsorted.og.lay.png" src="img/DRB1-3123_unsorted.og.lay.png" />
</div>
<div class="section" id="interactive-visualization-with-gfaestus">
<h3>Interactive visualization with gfaestus<a class="headerlink" href="#interactive-visualization-with-gfaestus" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>odgi layout -i DRB1-3123_unsorted.og -o DRB1-3123_unsorted.og.lay -P --threads <span class="m">2</span> -T DRB1-3123_unsorted.og.tsv
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gfaestus test/DRB1-3123_unsorted.gfa DRB1-3123_unsorted.og.tsv
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="translate_path_positions_between_graphs.html" class="btn btn-neutral float-right" title="Translate path positions between graphs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="extract_selected_loci.html" class="btn btn-neutral float-left" title="Extract selected loci" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Erik Garrison. Revision v0.5.1-00d68c2.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>